<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">var extend      = require(&quot;./extend&quot;);
var Promise     = require(&quot;./promise&quot;);
var Revalidator = require(&quot;revalidator&quot;);
var Restify     = require(&quot;restify&quot;);
var URL         = require(&quot;url&quot;);

(function (module) {
    &quot;use strict&quot;;
    /* Special options parsed from the extend call, not instance properties
     */
    var RES_OPTIONS = [&quot;url&quot;, &quot;parse&quot;];

<span id='Resource-method-constructor'><span id='Resource'>    /**
</span></span>     * @class Resource
     * A web resource. Properties and utilities for describing, operating on,
     * and managing data across web services.
     * 
     * A resource can be a simple container for properties with validation:
     * 
     *     @example
     *     var Cat = Resource.extend({
     *         breed: { type: &quot;string&quot; },
     *         lives: { type: &quot;number&quot; }
     *     });
     *     var cat = new Cat({ breed: &quot;Siamese&quot; });
     *     // Changed my mind...
     *     cat.property(&quot;breed&quot;, &quot;Bengal&quot;); // OK
     *     cat.property(&quot;lives&quot;, &quot;Nine&quot;); // NOT OK!
     * 
     * A resource can also be fetched remotely:
     * 
     *     @example
     *     var Cat = Resource.extend({ url: &quot;http://catserver.com/cat/5&quot; });
     *     var cat = new Cat();
     *     cat.fetch().done(function () {
     *         alert(this.properties())
     *     });
     * 
     * @constructor
     * Creates a resource.
     * 
     * @param {Object} properties A set of initial properties
     */
    function Resource(properties) {
        var name;
        for (name in properties) {
            if (properties.hasOwnProperty(name)) {
                this.property(name, properties[name]);
            }
        }
    }

<span id='Resource-method-schema'>    /**
</span>     * @method
     * Returns the schema that describes the resource.
     * @return {Object} A schema object
     */
    Resource.prototype.schema = function () {
        return this.schema;
    };

<span id='Resource-method-fetch'>    /**
</span>     * @method fetch
     * Fetches the resource from a remote service.
     * @return {Object} A promise
     * @return {Function} return.done A handler for after the resource is
     *         fetched from the server.
     */
    Resource.prototype.fetch = function () {
        var self = this,
            promise = new Promise(this),
            url;
        if (self.url() === null) {
            try {
                promise.resolve(self.parse());
            } catch (exception) {
                promise.resolveFail(exception);
            }
        } else {
            url = URL.parse(self.url());
            if (self.client === undefined) {
                self.client = Restify.createJsonClient({
                    url: URL.format({
                        host: url.host,
                        protocol: url.protocol
                    })
                });
            }
            self.client.get(url.path, function (err, req, res, obj) {
                try {
                    var parsed = self.parse(obj);
                    self.defaultParse(parsed);
                    promise.resolve(err, parsed);
                } catch (exception) {
                    promise.resolveFail(exception);
                }
            });
        }
        return promise;
    };

<span id='global-method-schema'>    /** @ignore */
</span>    Resource.schema = function () { return {}; };

<span id='Resource-method-property'>    /**
</span>     * @method property
     * Gets or sets a property. If the property has a schema defined, then the
     * value is validated.
     * 
     * @param {String} name    The name of the property
     * @param value (optional) The value of the property
     * @return {Mixed} The value of the property
     * 
     * See {@link Resource#extend}
     */
    Resource.prototype.property = function (prop, value) {
        this.props = (this.props || {});
        if (value !== undefined) {
            var schema = this.schema();
            if (schema[prop] !== undefined) {
                var test = {}; test[prop] = value;
                var valid = Revalidator.validate(
                    test, { properties: schema }
                );
                if (!valid.valid) {
                    var errs = [];
                    valid.errors.forEach(function (e) {
                        errs.push(e.property + &quot; &quot; + e.message);
                    });
                    throw new Error(errs.join(&quot;\n&quot;));
                }
            }
            this.props[prop] = value;
        }
        return this.props[prop];
    };

<span id='Resource-method-properties'>    /**
</span>     * @method
     * Gets the set of service properties.
     * 
     * @return The set of properties
     */
    Resource.prototype.properties = function () {
        return this.props;
    };

<span id='Resource-static-method-url'>    /**
</span>     * @method url
     * Returns the URL backing the resource.
     * @return {String}
     * @static
     */
    Resource.url = Resource.prototype.url = function () {
        return null;
    };

<span id='Resource-method-parse'>    /**
</span>     * @method parse
     * Parses data into the resource.
     * @param {Object} data The JSON object to be parsed
     * @return {Object} A JSON object
     */
    Resource.parse = Resource.prototype.parse = function (data) {
        return data;
    };

<span id='global-method-defaultParse'>    /** @ignore */
</span>    Resource.prototype.defaultParse = function (parsed) {
        var key;
        for (key in parsed) {
            if (parsed.hasOwnProperty(key))
                this.property(key, parsed[key]);
        }
    };


<span id='Resource-static-method-extend'>    /**
</span>     * @method extend
     * Extends the resource by specifying a validating schema.
     * 
     * @param {Object} schema       The schema to use
     * @param {String} schema.key   The name of a property
     * @param {Object} schema.value Descriptor of the property
     * 
     * @return {Resource} the extended resource
     * 
     * @static
     */
    Resource.extend = function (args) {
        args = (args || {});
        var Extended = extend.apply(this, arguments);
        var schema = {};
        for (var a in args) {
            if (args.hasOwnProperty(a) &amp;&amp; typeof(args[a]) === &quot;object&quot;)
                schema[a] = args[a];
        }
        RES_OPTIONS.forEach(function (option) {
            if (args.hasOwnProperty(option)) {
                schema[option] = undefined;
                if (typeof(args[option]) === &quot;function&quot;) {
                    Extended[option] = Extended.prototype[option] =
                        args[option];
                } else {
                    Extended[option] = Extended.prototype[option] =
                    (function () {
                        var value = args[option];
                        return function () {
                            return value;
                        };
                    })();
                }
            }
        });
        Extended.schema = Extended.prototype.schema = function () {
            return schema;
        };
        return Extended;
    };

    module.exports = Resource;

})(module);</pre>
</body>
</html>
